<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>

<dom-module id="transit-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>      
    <style is="custom-style">
                  /* paper toolbar styling */ 
                    paper-toolbar.red {
                      opacity: 0.7;
                      --paper-toolbar-background: #8D49B5;
                      --paper-toolbar-title: {
                        font-style: inherit;
                        font-weight: bold;
                      };
                    }
                      /*paper card styling */
                          paper-card{
                            min-width: 100%;
                            opacity: 0.9;
                            --paper-card-header: {
                            @apply(--layout-vertical);
                            @apply(--layout-center);
                        };
                       }
                      
                     .logo {
                         text-align: center;
                     }
                     .logo a {
                         font-size: 20px;
                         font-weight: 600;
                         letter-spacing: 0.3em;
                         color: black;
                         text-decoration: none;
                         text-align: center;
                         /* required for IE 11, so this <a> can receive pointer events */
                         display: inline-block;
                         pointer-events: auto;
                     }

                     .logo a:focus {
                         outline: 1.5px dotted  black;
                     }
                     .selector {
                         width: 250px;
                     }
                     .dpb{
                      position: relative;
                      margin-left: 23%;
                      margin-right: 20%;
                     }
                     
                    paper-dropdown-menu ~ paper-dropdown-menu {
                                  padding-left: 20%;
                                  }
                      span ~ span {
                                  padding-left: 33%;
                                  }
                       #origin ~ #destination{
                                  padding-left: 30%;
                                  }
                       paper-button {
                                  margin-left: 38%;

                                  }
                      #det,#sstation{
                        margin-top: 4%;
                        margin-left: 5%;
                        margin-right: 5%
                        
                      }
                      #sstation{
                        margin-top: 4%;
                        margin-left: 38%;
                        margin-right: 5%
                        
                      }
                      table {
                                font-family: arial, sans-serif;
                                border-collapse: collapse;
                                width: 100%;
                            }

                     td, th {  
                                border: 1px solid #dddddd;
                                text-align: center;
                                padding: 20px;
                            }

                     tr:nth-child(odd) {
                                background-color: #dddddd;
                            }
    </style>
    <paper-header-panel class="flex" mode="waterfall" >
      <paper-toolbar class="red"; style="width:100%; height: 110px;">
      <div class="logo title" ><a href="/" aria-label="Transit Home">[[prop1]]</a></div>
      </paper-toolbar>
    </paper-header-panel>
    <paper-card  heading="Departure - Arrival" >
       <div class="card-content">
          <h3 align="center">Enter trip details below</h3>
               <!--
                          <template is="dom-bind" id="Demo">
                            <paper-dropdown-menu label="Dinosaurs">
                              <paper-listbox class="dropdown-content">
                                <template is="dom-repeat" items='[[dinosaurs]]' as="dinosaur">
                                  <paper-item>[[dinosaur]]</paper-item>
                                </template>
                              </paper-listbox>
                            </paper-dropdown-menu>
                          </template>           
                          <script>
                                   document.addEventListener('WebComponentsReady', function() {
                                           Demo.dinosaurs = [
                                             'allosaurus',
                                             'brontosaurus',
                                             'carcharodontosaurus',
                                             'diplodocus',
                                             'ekrixinatosaurus',
                                             'fukuiraptor',
                                             'gallimimus',
                                             'hadrosaurus',
                                             'iguanodon',
                                             'jainosaurus',
                                             'kritosaurus',
                                             'liaoceratops',
                                             'megalosaurus',
                                             'nemegtosaurus',
                                             'ornithomimus',
                                             'protoceratops',
                                             'quetecsaurus',
                                             'rajasaurus',
                                             'stegosaurus',
                                             'triceratops',
                                            'utahraptor',
                                            'vulcanodon',
                                            'wannanosaurus',
                                            'xenoceratops',
                                            'yandusaurus',
                                            'zephyrosaurus'
                                          ];
                                      });
                          </script>
                -->

                <div class="dpb">
                          <template is="dom-bind" id="Stationn">
                                  <!--Dropdown to select Origin Station-->
                                      <paper-dropdown-menu id="from" label="From" class="selector" >                
                                        <paper-listbox class="dropdown-content" selected="{{selectedu}}" attr-for-selected="myid">
                                            <template is="dom-repeat" items='[[stationnames]]' as="stationname">
                                                <paper-item myid="[[stationname.id]]">[[stationname.Name]]</paper-item>
                                            </template>
                                        </paper-listbox>
                                      </paper-dropdown-menu>
                                      <!--Dropdown to select Destination Station-->      
                                      <paper-dropdown-menu id="to" label="To" class="selector" >                
                                        <paper-listbox class="dropdown-content" selected="{{selectedv}}" attr-for-selected="myid">
                                            <template is="dom-repeat" items='[[stationnames]]' as="stationname">
                                                <paper-item myid="[[stationname.id]]">[[stationname.Name]]</paper-item>
                                            </template>
                                        </paper-listbox>
                                      </paper-dropdown-menu> <br>
                                      <span>Selected Station Code: [[selectedu]]</span>
                                      <span>Selected Station Code: [[selectedv]]</span> </br>
                                      <paper-button raised noink onclick='search()'>Search</paper-button>
                                      <br>
                                      <div id="sstation" style="display: none;"></div>
                                      <div id="det" style="display: none;">
                                      <!--Schedule Display--> 
                                            <table>
                                                    <tr>
                                                      <th colspan="2" id="origin" > </th>
                                                      <th colspan="2" id="destination"> </th>
                                                    </tr>
                                                        <tr>
                                                          <th>Origin</th>
                                                          <th>Departure</th>
                                                          <th>Destination</th>
                                                          <th>Arrival</th>
                                                        </tr>
                                                        <template is="dom-repeat" items='[[tripdetails]]' as="tripdetail">
                                                              <tr>
                                                                <td>[[tripdetail._origin]]</td>
                                                                <td>[[tripdetail._origTimeDate]] [[tripdetail._origTimeMin]]</td> 
                                                                <td>[[tripdetail._destination]]</td>
                                                                <td>[[tripdetail._destTimeDate]] [[tripdetail._destTimeMin]]</td>
                                                              </tr>
                                                        </template>
                                            </table> 
                                   </div>      
                          </template>
                          <script src="./xml2json.js"></script>
                              <script>
                              /* script to get Station Name and Station abbreviation into an array object*/
                               Stationn.stationnames = [];
                                 fetch('http://api.bart.gov/api/stn.aspx?cmd=stns&key=MW9S-E7SL-26DU-VV8V').then(function(response){
                                    if(response.ok) {
                                    response.text().then(function(myText) {
                                        let x2js = new X2JS();
                                        let jsonObj = x2js.xml_str2json( myText );
                                        let StationListArray=[];
                                        let RouteArray = jsonObj.root.stations.station;
                                        //console.log(RouteArray); 
                                          for(let i=0; i< RouteArray.length; i++){
                                                let Name = RouteArray[i].name;
                                                let id =  RouteArray[i].abbr.toLowerCase();
                                                let tempObj={};
                                                tempObj.id=id; 
                                                tempObj.Name=Name;                           
                                                StationListArray.push(tempObj);
                                          }
                                           
                                            Stationn.stationnames=StationListArray;                                 
                                             console.log(Stationn.stationnames); 
                                                   
                                      });
                                    }
                                  }); 

                                  Stationn.tripdetails = [];

                                    /* function that gets invoked on clicking the paper button*/
                                  function search() { 
                                                      var from= [];
                                                      var to= [];
                                                      var selectedItemf = document.querySelector('#from').value; 
                                                      //console.log(selectedItemf);
                                                       Stationn.stationnames.filter(function(item){
                                                               if(item.Name==selectedItemf)
                                                                from.push(item);                                               
                                                      });
                                                      //console.log(from[0].id);
                                                      from= from[0].id;  //Abbreviation obtained though filtering after dropdown selection
                                                      console.log("from "+from);

                                                      var selectedItemto = document.querySelector('#to').value;
                                                      //console.log(selectedItemto);
                                                       Stationn.stationnames.filter(function(item){
                                                               if(item.Name==selectedItemto)
                                                                to.push(item);                                               
                                                      });
                                                      //console.log(to[0].id);
                                                      to= to[0].id;  //Abbreviation obtained though filtering after dropdown selection
                                                      console.log("to "+ to);
                                                      
                                                      document.getElementById("origin").innerHTML ="<strong>"+selectedItemf+"<strong>"; 
                                                      document.getElementById("destination").innerHTML ="<strong>"+selectedItemto+"<strong>"; 

                                                      //if-else to set display of Schedule 
                                                      if(from==to){
                                                        document.getElementById("det").style.display = "none";
                                                        document.getElementById("sstation").style.display = "inline-block";
                                                        document.getElementById("sstation").innerHTML ="<strong>Same Station<strong>"; 
                                                        document.getElementById(det).innerHTML="<strong>Same Stations</strong>"; 

                                                      }
                                                      else {
                                                        document.getElementById("det").style.display = "inline-block";
                                                        document.getElementById("sstation").style.display = "none";
                                                      }

                                                            //Promise that obtains the requested schedule
                                                            fetch('http://api.bart.gov/api/sched.aspx?cmd=depart&orig='+from+'&dest='+to+'&key=MW9S-E7SL-26DU-VV8V').then(function(response){
                                                                      if(response.ok) {
                                                                        response.text().then(function(myText) {
                                                                          let x2js = new X2JS();
                                                                          let jsonObj = x2js.xml_str2json( myText );
                                                                          //let StationArray=[];
                                                                          let StationschedArray = jsonObj.root.schedule.request.trip;
                                                                          //console.log(StationschedArray);
                                                                          Stationn.tripdetails= StationschedArray;
                                                                          console.log(Stationn.tripdetails);                
                                                                        })
                                                                      }                                                          
                                                                   }); 
                                                    }                                              
                                                                                     
                              </script>
                </div>
       </div>
    </paper-card>  
  </template>
  <script>
    Polymer({

      is: 'transit-app',

      properties: {
        prop1: {
          type: String,
          value: 'Transit-App',
        },        
      },
      
    });

  </script>
  
</dom-module>
<!--
<script type="text/javascript" src="app.js"></script>
-->